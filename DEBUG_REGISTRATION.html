<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Registration Process</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .section { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .error { background: #ffebee; color: #c62828; }
        .success { background: #e8f5e8; color: #2e7d32; }
        .warning { background: #fff3e0; color: #f57c00; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        input { margin: 5px; padding: 8px; width: 200px; }
        .log { background: #f8f9fa; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>Debug Registration Process</h1>
    
    <div class="section">
        <h3>Test Registration</h3>
        <p>This will test the registration process step by step to identify where it's failing.</p>
        
        <div>
            <input type="email" id="testEmail" placeholder="test@ntc.edu.ph" value="test@ntc.edu.ph">
            <input type="password" id="testPassword" placeholder="TestPass123!" value="TestPass123!">
            <input type="text" id="testName" placeholder="Test User" value="Test User">
            <input type="text" id="testStudentId" placeholder="12345" value="12345">
        </div>
        
        <button onclick="testRegistration()">Test Registration</button>
        <button onclick="clearLogs()">Clear Logs</button>
        
        <div id="logs" class="log"></div>
    </div>

    <div class="section">
        <h3>Check Current State</h3>
        <button onclick="checkFirestore()">Check Firestore</button>
        <button onclick="checkStorage()">Check Storage</button>
        <button onclick="checkAuth()">Check Auth Users</button>
        
        <div id="checkResults"></div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, collection, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getStorage, ref, listAll } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

        // You need to add your Firebase config here
        const firebaseConfig = {
            // Add your actual Firebase config
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : type === 'warning' ? 'orange' : 'black';
            logsDiv.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logsDiv.scrollTop = logsDiv.scrollHeight;
            console.log(message);
        }

        window.clearLogs = function() {
            document.getElementById('logs').innerHTML = '';
        };

        window.testRegistration = async function() {
            const email = document.getElementById('testEmail').value;
            const password = document.getElementById('testPassword').value;
            const name = document.getElementById('testName').value;
            const studentId = document.getElementById('testStudentId').value;

            log('üöÄ Starting registration test...', 'info');
            
            try {
                // Step 1: Create user in Firebase Auth
                log('üìù Step 1: Creating user in Firebase Auth...', 'info');
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                log(`‚úÖ User created successfully: ${user.uid}`, 'success');

                // Step 2: Create voter document
                log('üìÑ Step 2: Creating voter document in Firestore...', 'info');
                const voterDoc = {
                    fullName: name,
                    studentId: studentId,
                    email: email,
                    birthdate: '2000-01-01',
                    yearLevel: '1st Year',
                    school: 'SOB',
                    status: 'pending',
                    emailVerified: false,
                    hasVoted: false,
                    createdAt: new Date(),
                    updatedAt: new Date()
                };

                await setDoc(doc(db, 'voters', user.uid), voterDoc);
                log(`‚úÖ Voter document created successfully`, 'success');

                // Step 3: Test file upload (simulate)
                log('üìÅ Step 3: Testing storage access...', 'info');
                const storageRef = ref(storage, `verification_docs/${user.uid}/test.txt`);
                log(`‚úÖ Storage reference created: ${storageRef.fullPath}`, 'success');

                log('üéâ Registration test completed successfully!', 'success');
                
                // Clean up - delete the test user
                log('üßπ Cleaning up test user...', 'info');
                await user.delete();
                log('‚úÖ Test user deleted', 'success');

            } catch (error) {
                log(`‚ùå Registration failed: ${error.message}`, 'error');
                log(`Error code: ${error.code}`, 'error');
                console.error('Full error:', error);
                
                // Try to clean up if user was created
                if (auth.currentUser) {
                    try {
                        await auth.currentUser.delete();
                        log('üßπ Cleaned up partial user', 'warning');
                    } catch (cleanupError) {
                        log(`‚ùå Cleanup failed: ${cleanupError.message}`, 'error');
                    }
                }
            }
        };

        window.checkFirestore = async function() {
            const resultDiv = document.getElementById('checkResults');
            
            try {
                resultDiv.innerHTML = '<div>Checking Firestore...</div>';
                
                const votersSnapshot = await getDocs(collection(db, 'voters'));
                let html = `<h4>Firestore Voters (${votersSnapshot.size} total):</h4>`;
                
                votersSnapshot.forEach((doc) => {
                    const voter = doc.data();
                    html += `
                        <div style="border: 1px solid #ddd; padding: 10px; margin: 5px 0;">
                            <strong>ID:</strong> ${doc.id}<br>
                            <strong>Name:</strong> ${voter.fullName || 'N/A'}<br>
                            <strong>Email:</strong> ${voter.email || 'N/A'}<br>
                            <strong>Status:</strong> ${voter.status || 'N/A'}<br>
                            <strong>Has Doc URL:</strong> ${voter.verificationDocUrl ? 'Yes' : 'No'}
                        </div>
                    `;
                });
                
                resultDiv.innerHTML = html;
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Firestore check failed: ${error.message}</div>`;
            }
        };

        window.checkStorage = async function() {
            const resultDiv = document.getElementById('checkResults');
            
            try {
                resultDiv.innerHTML = '<div>Checking Storage...</div>';
                
                const verificationDocsRef = ref(storage, 'verification_docs');
                const result = await listAll(verificationDocsRef);
                
                let html = `<h4>Storage Files (${result.prefixes.length} folders):</h4>`;
                
                for (const folderRef of result.prefixes) {
                    const folderResult = await listAll(folderRef);
                    html += `
                        <div style="border: 1px solid #ddd; padding: 10px; margin: 5px 0;">
                            <strong>Folder:</strong> ${folderRef.name}<br>
                            <strong>Files:</strong> ${folderResult.items.length}<br>
                            ${folderResult.items.map(item => `‚Ä¢ ${item.name}`).join('<br>')}
                        </div>
                    `;
                }
                
                resultDiv.innerHTML = html;
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Storage check failed: ${error.message}</div>`;
            }
        };

        window.checkAuth = async function() {
            const resultDiv = document.getElementById('checkResults');
            
            try {
                resultDiv.innerHTML = `
                    <h4>Auth Status:</h4>
                    <div>Current User: ${auth.currentUser ? auth.currentUser.email : 'None'}</div>
                    <div>Auth State: ${auth.currentUser ? 'Authenticated' : 'Not authenticated'}</div>
                `;
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Auth check failed: ${error.message}</div>`;
            }
        };

        // Initialize
        log('üîß Debug tool loaded', 'info');
    </script>
</body>
</html>